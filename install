#!/usr/bin/env bash
set -eo pipefail; [[ $DOKKU_TRACE ]] && set -x

install_cmd() {
  local DOKKU_LOGSPOUT_ROOT="$DOKKU_ROOT/.logspout"
  local DOKKU_LOGSPOUT_DEFAULT_PORT=18000
  local DOKKU_LOGSPOUT_DEFAULT_IMAGE_VERSION="v3"
  local DOKKU_LOGSPOUT_OPTIONS="$DOKKU_LOGSPOUT_ROOT/OPTS"

  mkdir -p "$DOKKU_LOGSPOUT_ROOT"
  [[ ! -f $DOKKU_LOGSPOUT_OPTIONS ]] && echo "export DOKKU_LOGSPOUT_PORT=$DOKKU_LOGSPOUT_DEFAULT_PORT" > "$DOKKU_LOGSPOUT_OPTIONS"

  if ! (grep -q DOKKU_LOGSPOUT_IMAGE_VERSION "$DOKKU_LOGSPOUT_OPTIONS"); then
    echo "export DOKKU_LOGSPOUT_IMAGE_VERSION=$DOKKU_LOGSPOUT_DEFAULT_IMAGE_VERSION" >> "$DOKKU_LOGSPOUT_OPTIONS"
  fi
  chown -R dokku:dokku "$DOKKU_LOGSPOUT_ROOT"

  source "$DOKKU_LOGSPOUT_OPTIONS"
  docker pull "gliderlabs/logspout:${DOKKU_LOGSPOUT_IMAGE_VERSION}"
}

install_cmd "$@"
